import assert from 'assert'
import { _createModelsRecursive } from './models'
import { State } from './state'

describe('models', () => {
    describe('_createModelsRecursive', () => {
        it('should compute proper transform function', () => {
            const patchPlayer: State = {
                pdJson: {
                    patches: {
                        0: {
                            id: '0',
                            nodes: {
                                0: {
                                    id: '0',
                                    type: 'bla',
                                    nodeClass: 'generic',
                                    args: ['some-args'],
                                    layout: { x: 0, y: 0, width: 0, height: 0 },
                                },
                                1: {
                                    id: '1',
                                    type: 'hsl',
                                    nodeClass: 'control',
                                    args: [11, 22, 1, 33, '', ''],
                                    layout: {
                                        x: 10,
                                        y: 20,
                                        width: 25,
                                        height: 75,
                                    },
                                },
                                2: {
                                    id: '2',
                                    type: 'pd',
                                    nodeClass: 'subpatch',
                                    args: ['some-args'],
                                    layout: { x: 0, y: 0, width: 0, height: 0 },
                                    patchId: '1',
                                },
                            },
                            layout: {
                                windowX: 0,
                                windowY: 0,
                                windowWidth: 1000,
                                windowHeight: 1000,
                            },
                        },
                        1: {
                            id: '1',
                            nodes: {
                                0: {
                                    id: '0',
                                    type: 'bla',
                                    nodeClass: 'generic',
                                    args: ['some-args'],
                                    layout: { x: 0, y: 0, width: 0, height: 0 },
                                },
                                // Is inside viewport
                                1: {
                                    id: '1',
                                    type: 'vsl',
                                    nodeClass: 'control',
                                    args: [11, 22, 1, 33, '', ''],
                                    layout: {
                                        x: 100,
                                        y: 100,
                                        width: 25,
                                        height: 150,
                                    },
                                },
                                // Is outside of viewport
                                2: {
                                    id: '2',
                                    type: 'tgl',
                                    nodeClass: 'control',
                                    args: [11, 1, 22, '', ''],
                                    layout: { x: 0, y: 0, size: 10 },
                                },
                                3: {
                                    id: '2',
                                    type: 'pd',
                                    nodeClass: 'subpatch',
                                    args: ['some-args'],
                                    layout: {
                                        x: 112,
                                        y: 112,
                                        width: 25,
                                        height: 150,
                                    },
                                    patchId: '2',
                                },
                            },
                            layout: {
                                graphOnParent: 1,
                                viewportX: 100,
                                viewportY: 100,
                                viewportWidth: 25,
                                viewportHeight: 150,
                            },
                        },
                        2: {
                            id: '2',
                            nodes: {
                                0: {
                                    id: '0',
                                    type: 'bla',
                                    nodeClass: 'generic',
                                    args: ['some-args'],
                                    layout: { x: 0, y: 0, width: 0, height: 0 },
                                },
                                // Is inside viewport, but outside of intersection with parent viewport
                                1: {
                                    id: '1',
                                    type: 'hradio',
                                    nodeClass: 'control',
                                    args: [11, 1, 22, '', '', 0],
                                    layout: {
                                        x: 80,
                                        y: 0,
                                    },
                                },
                                // Is inside viewport
                                2: {
                                    id: '2',
                                    type: 'tgl',
                                    nodeClass: 'control',
                                    args: [11, 1, 22, '', ''],
                                    layout: { x: 2, y: 2, size: 5 },
                                },
                                3: {
                                    id: '2',
                                    type: 'pd',
                                    nodeClass: 'subpatch',
                                    args: ['some-args'],
                                    layout: {
                                        x: -1000,
                                        y: -1000,
                                        width: 0,
                                        height: 0,
                                    },
                                    patchId: '1',
                                },
                            },
                            layout: {
                                graphOnParent: 1,
                                viewportX: 0,
                                viewportY: 0,
                                viewportWidth: 1000,
                                viewportHeight: 1000,
                            },
                        },
                    },
                },
            }

            let controls = _createModelsRecursive(patchPlayer, patchPlayer.pdJson.patches['0']).sort(
                (a, b) => ('' + a.graphNodeId).localeCompare(b.graphNodeId)
            )
            let nextControls

            // patch 0
            assert.strictEqual(controls.length, 2)
            assert.deepStrictEqual(controls[0], {
                type: 'control',
                patch: patchPlayer.pdJson.patches['0'],
                node: patchPlayer.pdJson.patches['0'].nodes['1'],
            })
            nextControls = controls[1].children
            delete controls[1].children
            assert.deepStrictEqual(controls[1], {
                type: 'container',
                patch: patchPlayer.pdJson.patches['0'],
                node: patchPlayer.pdJson.patches['0'].nodes['2'],
            })

            // subpatch 1
            controls = nextControls
            assert.strictEqual(controls.length, 2)
            assert.deepStrictEqual(controls[0], {
                type: 'control',
                patch: patchPlayer.pdJson.patches['1'],
                node: patchPlayer.pdJson.patches['1'].nodes['1'],
            })
            nextControls = controls[1].children
            delete controls[1].children
            assert.deepStrictEqual(controls[1], {
                type: 'container',
                patch: patchPlayer.pdJson.patches['1'],
                node: patchPlayer.pdJson.patches['1'].nodes['3'],
            })

            // subpatch 2
            controls = nextControls
            assert.strictEqual(controls.length, 1)
            assert.deepStrictEqual(controls[0], {
                type: 'control',
                patch: patchPlayer.pdJson.patches['2'],
                node: patchPlayer.pdJson.patches['2'].nodes['2'],
            })
        })
    })
})
